@* Form Permissions Tab - Role-based permissions configuration *@
@using Requestr.Core.Models
@using Requestr.Core.Services

<div class="row">
    <div class="col-12">
        <!-- Role-Based Permissions Card -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Role-Based Permissions</h5>
                <div>
                    <button type="button" class="btn btn-outline-primary btn-sm me-2" @onclick="OnRefresh">
                        Refresh
                    </button>
                    <button type="button" class="btn btn-primary btn-sm" @onclick="OnSave" disabled="@IsLoading">
                        @if (IsLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                        }
                        Save Permissions
                    </button>
                </div>
            </div>
            <div class="card-body">
                @if (IsLoading)
                {
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading permissions...</span>
                        </div>
                        <p class="mt-2">Loading permissions...</p>
                    </div>
                }
                else
                {
                    <p class="text-muted mb-4">Configure which Entra ID app roles can perform specific operations on this form. Permissions are organized by category for easier management.</p>
                    
                    @if (PermissionsByCategory.Any())
                    {
                        <div class="row">
                            <div class="col-lg-3">
                                <!-- Role Selection -->
                                <div class="card bg-light">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">Roles</h6>
                                        <button type="button" class="btn btn-outline-primary btn-sm" @onclick="ShowAddRole">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                    <div class="card-body p-2">
                                        @if (_isAddingRole)
                                        {
                                            <div class="card mb-2 border-primary">
                                                <div class="card-body p-2">
                                                    <div class="mb-2">
                                                        <input type="text" 
                                                               class="form-control form-control-sm" 
                                                               placeholder="Enter role name..."
                                                               @bind="_newRoleName"
                                                               @onkeypress="@(async (e) => { if (e.Key == "Enter") await AddRole(); })" />
                                                    </div>
                                                    <div class="d-flex gap-1">
                                                        <button type="button" class="btn btn-primary btn-sm flex-fill" @onclick="AddRole" disabled="@(string.IsNullOrWhiteSpace(_newRoleName))">
                                                            Add
                                                        </button>
                                                        <button type="button" class="btn btn-secondary btn-sm flex-fill" @onclick="CancelAddRole">
                                                            Cancel
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                        
                                        <div class="list-group list-group-flush">
                                            @foreach (var role in AvailableRoles)
                                            {
                                                <div class="list-group-item list-group-item-action @(SelectedRole == role ? "active" : "") p-0">
                                                    <div class="d-flex align-items-center">
                                                        <button type="button" 
                                                                class="btn btn-link flex-fill text-start border-0 @(SelectedRole == role ? "text-white" : "")"
                                                                @onclick="() => SelectRole(role)">
                                                            <div class="d-flex justify-content-between align-items-center w-100">
                                                                <div>
                                                                    <strong>@role</strong>
                                                                    <br />
                                                                    <small class="@(SelectedRole == role ? "text-white-50" : "text-muted")">
                                                                        @GetRolePermissionSummary(role)
                                                                    </small>
                                                                </div>
                                                                @if (SelectedRole == role)
                                                                {
                                                                    <i class="bi bi-check-circle text-white"></i>
                                                                }
                                                            </div>
                                                        </button>
                                                        @if (CanDeleteRole(role))
                                                        {
                                                            <button type="button" 
                                                                    class="btn btn-sm btn-outline-danger me-2" 
                                                                    title="Remove role"
                                                                    @onclick="() => ConfirmDeleteRole(role)">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-9">
                                @if (!string.IsNullOrEmpty(SelectedRole))
                                {
                                    <!-- Permission Categories -->
                                    <div class="row">
                                        @foreach (var category in PermissionsByCategory)
                                        {
                                            <div class="col-md-6 mb-4">
                                                <div class="card h-100">
                                                    <div class="card-header bg-white">
                                                        <h6 class="mb-0 @FormPermissionHelper.GetCategoryColorClass(category.Key)">
                                                            <i class="bi @FormPermissionHelper.GetCategoryIcon(category.Key) me-2"></i>
                                                            @category.Key
                                                        </h6>
                                                    </div>
                                                    <div class="card-body">
                                                        @foreach (var permission in category.Value)
                                                        {
                                                            var isGranted = GetPermissionState(SelectedRole, permission);
                                                            var isDangerous = FormPermissionHelper.IsDangerousPermission(permission);
                                                            var prerequisites = FormPermissionHelper.GetPrerequisitePermissions(permission);
                                                            var hasUnmetPrerequisites = prerequisites.Any(p => !GetPermissionState(SelectedRole, p));
                                                            
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input @(isDangerous ? "border-danger" : "")" 
                                                                       type="checkbox" 
                                                                       checked="@isGranted"
                                                                       disabled="@hasUnmetPrerequisites"
                                                                       @onchange="@((ChangeEventArgs e) => SetPermission(SelectedRole, permission, (bool)e.Value!))"
                                                                       id="perm_@(SelectedRole)_@((int)permission)" />
                                                                <label class="form-check-label @(hasUnmetPrerequisites ? "text-muted" : "")" 
                                                                       for="perm_@(SelectedRole)_@((int)permission)">
                                                                    <span class="@(isDangerous ? "text-danger fw-bold" : "")">
                                                                        @FormPermissionHelper.GetPermissionDescription(permission)
                                                                    </span>
                                                                    @if (isDangerous)
                                                                    {
                                                                        <i class="bi bi-exclamation-triangle text-danger ms-1" title="Dangerous permission"></i>
                                                                    }
                                                                    @if (hasUnmetPrerequisites)
                                                                    {
                                                                        <br />
                                                                        <small class="text-muted">
                                                                            Requires: @string.Join(", ", prerequisites.Select(p => FormPermissionHelper.GetPermissionDescription(p).Split(' ').Take(2).Aggregate((a, b) => a + " " + b)))
                                                                        </small>
                                                                    }
                                                                </label>
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="text-center p-5 text-muted">
                                        <p class="mt-3">Select a role from the left to configure its permissions</p>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="text-center p-5">
                            <p class="mt-3">No permissions have been configured yet. Save the form first to set up permissions.</p>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
    private bool _isAddingRole = false;
    private string _newRoleName = "";

    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public List<string> AvailableRoles { get; set; } = new();
    [Parameter] public string SelectedRole { get; set; } = "";
    [Parameter] public Dictionary<string, List<FormPermissionType>> PermissionsByCategory { get; set; } = new();
    [Parameter] public Dictionary<string, Dictionary<FormPermissionType, bool>> CurrentPermissions { get; set; } = new();
    
    [Parameter] public EventCallback OnRefreshClicked { get; set; }
    [Parameter] public EventCallback OnSaveClicked { get; set; }
    [Parameter] public EventCallback<string> OnRoleSelected { get; set; }
    [Parameter] public EventCallback<string> OnAddRole { get; set; }
    [Parameter] public EventCallback<string> OnDeleteRole { get; set; }
    [Parameter] public EventCallback<(string Role, FormPermissionType Permission, bool IsGranted)> OnPermissionChanged { get; set; }

    private async Task OnRefresh() => await OnRefreshClicked.InvokeAsync();
    private async Task OnSave() => await OnSaveClicked.InvokeAsync();

    private async Task SelectRole(string role)
    {
        await OnRoleSelected.InvokeAsync(role);
    }

    private void ShowAddRole()
    {
        _isAddingRole = true;
        _newRoleName = "";
    }

    private void CancelAddRole()
    {
        _isAddingRole = false;
        _newRoleName = "";
    }

    private async Task AddRole()
    {
        if (!string.IsNullOrWhiteSpace(_newRoleName))
        {
            await OnAddRole.InvokeAsync(_newRoleName.Trim());
            _isAddingRole = false;
            _newRoleName = "";
        }
    }

    private async Task ConfirmDeleteRole(string role)
    {
        await OnDeleteRole.InvokeAsync(role);
    }

    private bool CanDeleteRole(string role)
    {
        // Don't allow deleting Admin or User roles
        return role != "Admin" && role != "User";
    }

    private bool GetPermissionState(string roleName, FormPermissionType permissionType)
    {
        if (CurrentPermissions.TryGetValue(roleName, out var rolePermissions))
        {
            return rolePermissions.TryGetValue(permissionType, out var isGranted) && isGranted;
        }
        return false;
    }

    private async Task SetPermission(string roleName, FormPermissionType permissionType, bool isGranted)
    {
        await OnPermissionChanged.InvokeAsync((roleName, permissionType, isGranted));
    }

    private string GetRolePermissionSummary(string roleName)
    {
        if (CurrentPermissions.TryGetValue(roleName, out var permissions))
        {
            var grantedCount = permissions.Values.Count(v => v);
            var totalCount = permissions.Count;
            return $"{grantedCount}/{totalCount} permissions";
        }
        return "0 permissions";
    }
}
