@* RequestFieldValuesCard - Unified card for displaying field values with diffs *@
@* Works for both standard requests and individual bulk request items *@
@using Requestr.Core.Models
@using Requestr.Web.Components.Shared

<div class="card @(Compact ? "border-0" : "mb-4")">
    @if (ShowHeader)
    {
        <div class="card-header @GetHeaderClass()">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    @if (RowNumber.HasValue)
                    {
                        <span class="fw-bold">Row @RowNumber</span>
                    }
                    else
                    {
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul me-2"></i>Field Values
                        </h5>
                    }
                    @if (Status.HasValue)
                    {
                        <span class="badge @GetStatusBadgeClass()">@Status</span>
                    }
                    @if (!string.IsNullOrEmpty(KeySummary))
                    {
                        <span class="text-muted small">@KeySummary</span>
                    }
                </div>
                @if (Collapsible)
                {
                    <button type="button" class="btn btn-sm btn-link p-0" @onclick="ToggleCollapsed">
                        <i class="bi @(IsCollapsed ? "bi-chevron-down" : "bi-chevron-up")"></i>
                    </button>
                }
            </div>
        </div>
    }
    
    @if (!IsCollapsed)
    {
        <div class="card-body @(Compact ? "p-0 pt-2" : "")">
            @if (FieldValues?.Any() == true)
            {
                <div class="field-values-grid">
                    @{
                        var displayableFields = GetDisplayableFields().ToList();
                        var lastField = displayableFields.LastOrDefault();
                    }
                    @foreach (var field in displayableFields)
                    {
                        var displayName = GetDisplayName(field.Key);
                        var originalValue = GetOriginalValue(field.Key);
                        var showBorder = field.Key != lastField.Key;
                        
                        <FieldValueDisplay 
                            FieldName="@field.Key"
                            DisplayName="@displayName"
                            NewValue="@field.Value"
                            OriginalValue="@originalValue"
                            ShowOriginal="@ShowOriginalValues"
                            ShowBorder="@showBorder"
                            RequestType="@RequestType" />
                    }
                </div>
            }
            else
            {
                <p class="text-muted mb-0">No field values available.</p>
            }
            
            @* Processing result for bulk items *@
            @if (!string.IsNullOrEmpty(ProcessingResult))
            {
                <div class="mt-3 pt-3 border-top">
                    <div class="d-flex align-items-start gap-2 @(Status == RequestStatus.Failed ? "text-danger" : "text-success")">
                        <i class="bi @(Status == RequestStatus.Failed ? "bi-exclamation-triangle-fill" : "bi-check-circle-fill")"></i>
                        <div>
                            <strong class="d-block">@(Status == RequestStatus.Failed ? "Error Details" : "Result")</strong>
                            <span class="text-break">@ProcessingResult</span>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    /// <summary>Field values to display (new/proposed values)</summary>
    [Parameter] public Dictionary<string, object?>? FieldValues { get; set; }
    
    /// <summary>Original values for comparison (for Update/Delete)</summary>
    [Parameter] public Dictionary<string, object?>? OriginalValues { get; set; }
    
    /// <summary>Form fields for display name lookup</summary>
    [Parameter] public List<FormField>? FormFields { get; set; }
    
    /// <summary>Request type affects whether originals are shown</summary>
    [Parameter] public RequestType RequestType { get; set; } = RequestType.Insert;
    
    /// <summary>Status of the request/item (optional, for bulk items)</summary>
    [Parameter] public RequestStatus? Status { get; set; }
    
    /// <summary>Row number (for bulk request items)</summary>
    [Parameter] public int? RowNumber { get; set; }
    
    /// <summary>Key field summary (e.g., "CountryCode: AUS")</summary>
    [Parameter] public string? KeySummary { get; set; }
    
    /// <summary>Processing result message (for applied/failed items)</summary>
    [Parameter] public string? ProcessingResult { get; set; }
    
    /// <summary>Whether to show the card header</summary>
    [Parameter] public bool ShowHeader { get; set; } = true;
    
    /// <summary>Whether the card can be collapsed</summary>
    [Parameter] public bool Collapsible { get; set; } = false;
    
    /// <summary>Initial collapsed state</summary>
    [Parameter] public bool StartCollapsed { get; set; } = true;
    
    /// <summary>Compact mode (no border, less padding)</summary>
    [Parameter] public bool Compact { get; set; } = false;
    
    /// <summary>Fields to exclude from display</summary>
    [Parameter] public HashSet<string>? ExcludeFields { get; set; }
    
    private bool IsCollapsed { get; set; }
    
    private bool ShowOriginalValues => RequestType != RequestType.Insert && OriginalValues?.Any() == true;

    protected override void OnInitialized()
    {
        IsCollapsed = Collapsible && StartCollapsed;
    }

    private void ToggleCollapsed()
    {
        IsCollapsed = !IsCollapsed;
    }

    private IEnumerable<KeyValuePair<string, object?>> GetDisplayableFields()
    {
        if (FieldValues == null) return Enumerable.Empty<KeyValuePair<string, object?>>();
        
        return FieldValues.Where(f => 
            !string.IsNullOrEmpty(f.Key) && 
            (ExcludeFields == null || !ExcludeFields.Contains(f.Key)));
    }

    private string GetDisplayName(string fieldName)
    {
        var field = FormFields?.FirstOrDefault(f => 
            string.Equals(f.Name, fieldName, StringComparison.OrdinalIgnoreCase));
        return field?.DisplayName ?? fieldName;
    }

    private object? GetOriginalValue(string fieldName)
    {
        if (OriginalValues == null) return null;
        
        // Case-insensitive lookup
        var key = OriginalValues.Keys.FirstOrDefault(k => 
            string.Equals(k, fieldName, StringComparison.OrdinalIgnoreCase));
        
        return key != null ? OriginalValues[key] : null;
    }

    private string GetHeaderClass()
    {
        if (!Status.HasValue) return "";
        
        return Status.Value switch
        {
            RequestStatus.Failed => "bg-danger bg-opacity-10",
            RequestStatus.Applied => "bg-success bg-opacity-10",
            RequestStatus.Rejected => "bg-danger bg-opacity-10",
            RequestStatus.Approved => "bg-success bg-opacity-10",
            _ => ""
        };
    }

    private string GetStatusBadgeClass() => Status switch
    {
        RequestStatus.Pending => "bg-warning text-dark",
        RequestStatus.Approved => "bg-success",
        RequestStatus.Rejected => "bg-danger",
        RequestStatus.Applied => "bg-success",
        RequestStatus.Failed => "bg-danger",
        _ => "bg-secondary"
    };
}
