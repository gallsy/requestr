@page "/requests/{RequestId:int}"
@using Requestr.Core.Models
@using Requestr.Core.Interfaces
@using System.Text.Json
@using Requestr.Web.Components
@using Requestr.Web.Components.Shared
@using Microsoft.AspNetCore.Authorization
@using BlazorBootstrap
@inject IFormRequestService FormRequestService
@inject IFormDefinitionService FormDefinitionService
@inject IConflictDetectionService ConflictDetectionService
@inject ILogger<RequestDetails> Logger
@inject NavigationManager Navigation
@inject IDatabaseService DatabaseService
@attribute [Authorize]

@if (_isLoading)
{
    <LoadingSpinner Message="Loading request details..." />
}
else if (_request == null)
{
    <EmptyState Title="Request Not Found" 
                Description="The requested form request could not be found or you don't have permission to access it.">
        <Action>
            <Button Color="ButtonColor.Primary" @onclick="@(() => Navigation.NavigateTo("/"))">
                Go Home
            </Button>
        </Action>
    </EmptyState>
}
else
{
    <PageHeader Title="@(_formDefinition?.Name ?? "Request Details")" 
                Description="@($"Request #{RequestId}")">
        <Actions>
            @if (_request.Status == RequestStatus.Pending && CanEditRequest())
            {
                <Button Color="ButtonColor.Primary" Outline="true" 
                        @onclick="@(() => Navigation.NavigateTo($"/forms/{_request.FormDefinitionId}/edit/{RequestId}"))">
                    <Icon Name="IconName.Pencil" class="me-1" />
                    Edit Request
                </Button>
            }
            <Button Color="ButtonColor.Secondary" @onclick="GoBack">
                <Icon Name="IconName.ArrowLeft" class="me-1" />
                Back
            </Button>
        </Actions>
    </PageHeader>

    <div class="container">
        <!-- Unified Request Summary Card -->
        <RequestSummaryCard 
            FormName="@(_formDefinition?.Name ?? "Unknown Form")"
            TableName="@_formDefinition?.TableName"
            RequestType="_request.RequestType"
            Status="_request.Status"
            Comments="@_request.Comments"
            RejectionReason="@_request.RejectionReason"
            SubmittedBy="@_request.RequestedByName"
            SubmittedAt="@_request.RequestedAt"
            ProcessedBy="@_request.ApprovedByName"
            ProcessedAt="@_request.ApprovedAt"
            HasWorkflow="@(_request.WorkflowInstanceId.HasValue)" />

        @if (!string.IsNullOrEmpty(_conflictWarning))
        {
            <StandardAlert AlertType="warning" 
                         Title="Data Conflicts Detected">
                <div style="white-space: pre-line;">@_conflictWarning</div>
            </StandardAlert>
        }

        <!-- Workflow Progress -->
        <WorkflowProgressDisplay FormRequestId="@RequestId" ShowCompact="false" AutoLoad="true" />

        <!-- Field Values Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>Field Values
                </h5>
            </div>
            <div class="card-body">
                @if (_request.FieldValues?.Any() == true)
                {
                    var showOriginalValues = _request.RequestType != RequestType.Insert && _request.OriginalValues?.Any() == true;
                    
                    <div class="field-values-grid">
                        @foreach (var fieldValue in GetDisplayableFieldValues())
                        {
                            var field = _formDefinition?.Fields?.FirstOrDefault(f => f.Name == fieldValue.Key);
                            var displayName = field?.DisplayName ?? fieldValue.Key;
                            var valueStr = fieldValue.Value?.ToString();
                            var hasOriginal = _request.RequestType != RequestType.Insert && 
                                             _request.OriginalValues?.ContainsKey(fieldValue.Key) == true;
                            var originalValue = hasOriginal ? _request.OriginalValues?[fieldValue.Key]?.ToString() : null;
                            var hasChanged = hasOriginal && !AreDisplayValuesEqual(originalValue, valueStr);

                            <div class="field-value-item py-3 @(fieldValue.Key != GetDisplayableFieldValues().Last().Key ? "border-bottom" : "")">
                                <div class="row align-items-start">
                                    <div class="col-md-4">
                                        <label class="form-label text-muted mb-0">@displayName</label>
                                        @if (hasChanged)
                                        {
                                            <span class="badge bg-warning text-dark ms-2" style="font-size: 0.7rem;">Changed</span>
                                        }
                                    </div>
                                    <div class="col-md-8">
                                        @if (showOriginalValues && hasOriginal)
                                        {
                                            @if (hasChanged)
                                            {
                                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                                    <span class="text-muted text-decoration-line-through">@(string.IsNullOrEmpty(originalValue) ? "(empty)" : originalValue)</span>
                                                    <i class="bi bi-arrow-right text-muted small"></i>
                                                    <span class="fw-medium">@(string.IsNullOrEmpty(valueStr) ? "(empty)" : valueStr)</span>
                                                </div>
                                            }
                                            else
                                            {
                                                <span>@(string.IsNullOrEmpty(valueStr) ? "(empty)" : valueStr)</span>
                                            }
                                        }
                                        else
                                        {
                                            <span>@(string.IsNullOrEmpty(valueStr) ? "(empty)" : valueStr)</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted mb-0">No field values available.</p>
                }
            </div>
        </div>

        <!-- Request History Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>Request History
                </h5>
            </div>
            <div class="card-body">
                @if (_requestHistory?.Any() == true)
                {
                    <div class="timeline">
                        @foreach (var historyItem in _requestHistory.OrderBy(h => h.ChangedAt))
                        {
                            <div class="timeline-item">
                                <div class="timeline-marker @GetHistoryMarkerColor(historyItem.ChangeType)">
                                    <i class="bi @GetHistoryIcon(historyItem.ChangeType)"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-header">
                                        <strong>@GetHistoryTitle(historyItem.ChangeType)</strong>
                                        <small class="text-muted">@historyItem.ChangedAt.ToString("MMM dd, yyyy 'at' h:mm tt")</small>
                                    </div>
                                    <div class="timeline-body">
                                        <p class="mb-1"><strong>By:</strong> @historyItem.ChangedByName</p>
                                        @if (!string.IsNullOrEmpty(historyItem.Comments))
                                        {
                                            <p class="mb-1"><strong>Comments:</strong> @historyItem.Comments</p>
                                        }
                                        
                                        @* Workflow-specific information *@
                                        @if (IsWorkflowHistoryType(historyItem.ChangeType))
                                        {
                                            <div class="mt-2">
                                                @if (historyItem.NewValues.ContainsKey("StepName"))
                                                {
                                                    <p class="mb-1"><strong>Step:</strong> @historyItem.NewValues["StepName"]</p>
                                                }
                                                @if (historyItem.NewValues.ContainsKey("Action"))
                                                {
                                                    <p class="mb-1"><strong>Action:</strong> <span class="badge @GetActionBadgeClass(historyItem.NewValues["Action"]?.ToString())">@historyItem.NewValues["Action"]</span></p>
                                                }
                                                @if (historyItem.NewValues.ContainsKey("WorkflowName"))
                                                {
                                                    <p class="mb-1"><strong>Workflow:</strong> @historyItem.NewValues["WorkflowName"]</p>
                                                }
                                                @if (historyItem.NewValues.ContainsKey("WasApproved"))
                                                {
                                                    var wasApproved = historyItem.NewValues["WasApproved"]?.ToString() == "True";
                                                    <p class="mb-1"><strong>Result:</strong> 
                                                        <span class="badge @(wasApproved ? "bg-success" : "bg-danger")">
                                                            @(wasApproved ? "Approved" : "Rejected")
                                                        </span>
                                                    </p>
                                                }
                                            </div>
                                        }
                                        
                                        @if (historyItem.ChangeType == FormRequestChangeType.StatusChanged || historyItem.ChangeType == FormRequestChangeType.Approved || historyItem.ChangeType == FormRequestChangeType.Rejected)
                                        {
                                            <div class="mt-2">
                                                @if (historyItem.PreviousValues.ContainsKey("Status"))
                                                {
                                                    <span class="badge bg-secondary me-2">@historyItem.PreviousValues["Status"]</span>
                                                    <i class="bi bi-arrow-right"></i>
                                                    <span class="badge bg-primary ms-2">@historyItem.NewValues["Status"]</span>
                                                }
                                            </div>
                                        }
                                        @if (historyItem.ChangeType == FormRequestChangeType.Updated && historyItem.NewValues.ContainsKey("FieldChanges"))
                                        {
                                            <div class="mt-2">
                                                <strong>Field Changes:</strong>
                                                <div class="mt-1">
                                                    @try
                                                    {
                                                        var fieldChangesJson = historyItem.NewValues["FieldChanges"];
                                                        if (fieldChangesJson != null)
                                                        {
                                                            // Parse the JSON element to get the field changes
                                                            var fieldChangesElement = (JsonElement)fieldChangesJson;
                                                            if (fieldChangesElement.ValueKind == JsonValueKind.Array)
                                                            {
                                                                foreach (var changeElement in fieldChangesElement.EnumerateArray())
                                                                {
                                                                    var fieldName = changeElement.GetProperty("FieldName").GetString() ?? "";
                                                                    var previousValue = changeElement.TryGetProperty("PreviousValue", out var prevProp) ? prevProp.GetString() : "null";
                                                                    var newValue = changeElement.TryGetProperty("NewValue", out var newProp) ? newProp.GetString() : "null";
                                                                    var changeType = changeElement.TryGetProperty("ChangeType", out var typeProp) ? typeProp.GetString() : "";
                                                                    
                                                                    var displayFieldName = fieldName.StartsWith("Original_") ? fieldName.Substring(9) + " (Original)" : fieldName;
                                                                    
                                                                    <div class="field-change-item mb-2 p-2 border rounded bg-light">
                                                                        <div class="d-flex justify-content-between align-items-center">
                                                                            <strong class="field-name">@displayFieldName:</strong>
                                                                            <small class="text-muted">@GetFieldDisplayName(fieldName)</small>
                                                                        </div>
                                                                        <div class="field-change-values mt-1">
                                                                            <div class="d-flex align-items-center">
                                                                                <span class="previous-value me-2">
                                                                                    <span class="badge bg-secondary">Previous:</span>
                                                                                    <code class="ms-1">@(previousValue ?? "null")</code>
                                                                                </span>
                                                                                <i class="bi bi-arrow-right mx-2"></i>
                                                                                <span class="new-value">
                                                                                    <span class="badge bg-primary">New:</span>
                                                                                    <code class="ms-1">@(newValue ?? "null")</code>
                                                                                </span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                }
                                                            }
                                                        }
                                                    }
                                                    catch (Exception ex)
                                                    {
                                                        <StandardAlert AlertType="warning" 
                                                                     Dismissable="false">
                                                            <small>Unable to parse field changes: @ex.Message</small>
                                                        </StandardAlert>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">No history available.</p>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int RequestId { get; set; }
    
    private FormRequest? _request;
    private FormDefinition? _formDefinition;
    private List<FormRequestHistory> _requestHistory = new();
    private List<ColumnInfo> _tableColumns = new();
    private bool _isLoading = true;
    private string _conflictWarning = "";
    
    // Workflow-related fields
    private WorkflowStepInstance? _currentWorkflowStep;
    private List<WorkflowStepInstance>? _completedWorkflowSteps;

    protected override async Task OnInitializedAsync()
    {
        await LoadRequest();
    }

    private async Task LoadRequest()
    {
        try
        {
            _isLoading = true;
            _request = await FormRequestService.GetFormRequestWithHistoryAsync(RequestId);
            
            if (_request != null)
            {
                _formDefinition = await FormDefinitionService.GetByIdAsync(_request.FormDefinitionId);
                _requestHistory = _request.History;

                // Load column metadata for filtering on display
                try
                {
                    if (_formDefinition != null)
                    {
                        _tableColumns = await DatabaseService.GetTableColumnsAsync(
                            _formDefinition.DatabaseConnectionName,
                            _formDefinition.TableName,
                            _formDefinition.Schema
                        );
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogWarning(ex, "Failed to load table columns for RequestDetails form {FormDefinitionId}", _request.FormDefinitionId);
                    _tableColumns = new List<ColumnInfo>();
                }
                
                // Load workflow information if request has a workflow
                if (_request.WorkflowInstanceId.HasValue)
                {
                    await LoadWorkflowInformation();
                }

                // Check for conflicts only if the request is not in a terminal state
                var isCompleted = _request.Status == RequestStatus.Approved || 
                                  _request.Status == RequestStatus.Rejected || 
                                  _request.Status == RequestStatus.Applied || 
                                  _request.Status == RequestStatus.Failed;
                if (!isCompleted && (_request.Status == RequestStatus.Pending || _request.WorkflowInstanceId.HasValue))
                {
                    await CheckForConflictsAsync();
                }
            }
        }
        catch (Exception)
        {
            // Log error - request will remain null and show not found message
        }
        finally
        {
            _isLoading = false;
        }
    }

    private IEnumerable<KeyValuePair<string, object?>> GetDisplayableFieldValues()
    {
        if (_request?.FieldValues == null)
            return Enumerable.Empty<KeyValuePair<string, object?>>();

        // For Insert requests, hide identity/computed/rowversion columns
        if (_request.RequestType == RequestType.Insert && _tableColumns != null && _tableColumns.Count > 0)
        {
            var autoCols = new HashSet<string>(_tableColumns
                .Where(c => c.IsIdentity || c.IsComputed || c.IsRowVersion)
                .Select(c => c.Name), StringComparer.OrdinalIgnoreCase);

            return _request.FieldValues.Where(kvp => !autoCols.Contains(kvp.Key));
        }

        return _request.FieldValues;
    }

    /// <summary>
    /// Compares two display values, handling datetime precision differences
    /// </summary>
    private bool AreDisplayValuesEqual(string? value1, string? value2)
    {
        if (value1 == value2) return true;
        if (string.IsNullOrEmpty(value1) && string.IsNullOrEmpty(value2)) return true;
        if (string.IsNullOrEmpty(value1) || string.IsNullOrEmpty(value2)) return false;

        // First try exact match (case-insensitive, trimmed)
        if (string.Equals(value1?.Trim(), value2?.Trim(), StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }

        // Only use datetime comparison if BOTH values look like datetimes (contain date separators and time components)
        var looksLikeDateTime1 = (value1.Contains("-") || value1.Contains("/")) && 
                                  (value1.Contains(":") || value1.Contains("T"));
        var looksLikeDateTime2 = (value2.Contains("-") || value2.Contains("/")) && 
                                  (value2.Contains(":") || value2.Contains("T"));
        
        if (looksLikeDateTime1 && looksLikeDateTime2 &&
            DateTime.TryParse(value1, System.Globalization.CultureInfo.InvariantCulture, 
                System.Globalization.DateTimeStyles.None, out var dt1) &&
            DateTime.TryParse(value2, System.Globalization.CultureInfo.InvariantCulture, 
                System.Globalization.DateTimeStyles.None, out var dt2))
        {
            // Compare with 1 second tolerance for precision differences
            return Math.Abs((dt1 - dt2).TotalSeconds) < 1;
        }

        // Values are different
        return false;
    }

    private async Task LoadWorkflowInformation()
    {
        try
        {
            if (_request != null)
            {
                _currentWorkflowStep = await FormRequestService.GetCurrentWorkflowStepAsync(_request.Id);
                _completedWorkflowSteps = await FormRequestService.GetCompletedWorkflowStepsAsync(_request.Id);
            }
        }
        catch (Exception)
        {
            // Log error - workflow information will remain null
        }
    }

    private async Task CheckForConflictsAsync()
    {
        try
        {
            if (_request?.Id > 0)
            {
                var conflictResult = await ConflictDetectionService.CheckForConflictsAsync(_request.Id);
                if (conflictResult.HasConflicts)
                {
                    _conflictWarning = string.Join("\n", conflictResult.ConflictMessages);
                }
            }
        }
        catch (Exception ex)
        {
            // Log the error but don't show it to the user since conflict detection is supplementary
            Logger.LogWarning(ex, "Conflict detection error for RequestId {RequestId}", RequestId);
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/requests");
    }

    private bool CanEditRequest()
    {
        // Users can edit their own pending requests
        return _request?.Status == RequestStatus.Pending;
    }

    private string GetStatusBadgeColor(RequestStatus status) => status switch
    {
        RequestStatus.Pending => "bg-warning",
        RequestStatus.Approved => "bg-success",
        RequestStatus.Rejected => "bg-danger",
        RequestStatus.Applied => "bg-info",
        _ => "bg-secondary"
    };

    private string GetRequestTypeBadgeColor(RequestType requestType) => requestType switch
    {
        RequestType.Insert => "bg-primary",
        RequestType.Update => "bg-info",
        RequestType.Delete => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetRequestTypeDisplayName(RequestType requestType) => requestType switch
    {
        RequestType.Insert => "Add New Record",
        RequestType.Update => "Update Record", 
        RequestType.Delete => "Delete Record",
        _ => requestType.ToString()
    };

    private string GetHistoryMarkerColor(FormRequestChangeType changeType) => changeType switch
    {
        FormRequestChangeType.Created => "bg-primary",
        FormRequestChangeType.Updated => "bg-info",
        FormRequestChangeType.StatusChanged => "bg-warning",
        FormRequestChangeType.Approved => "bg-success",
        FormRequestChangeType.Rejected => "bg-danger",
        FormRequestChangeType.Applied => "bg-success",
        FormRequestChangeType.Failed => "bg-danger",
        FormRequestChangeType.WorkflowStarted => "bg-primary",
        FormRequestChangeType.WorkflowStepCompleted => "bg-info",
        FormRequestChangeType.WorkflowStepApproved => "bg-success",
        FormRequestChangeType.WorkflowStepRejected => "bg-danger",
        FormRequestChangeType.WorkflowCompleted => "bg-success",
        _ => "bg-secondary"
    };

    private string GetHistoryIcon(FormRequestChangeType changeType) => changeType switch
    {
        FormRequestChangeType.Created => "bi-plus-circle",
        FormRequestChangeType.Updated => "bi-pencil-square",
        FormRequestChangeType.StatusChanged => "bi-arrow-repeat",
        FormRequestChangeType.Approved => "bi-check-circle",
        FormRequestChangeType.Rejected => "bi-x-circle",
        FormRequestChangeType.Applied => "bi-check2-all",
        FormRequestChangeType.Failed => "bi-exclamation-triangle",
        FormRequestChangeType.WorkflowStarted => "bi-play-circle",
        FormRequestChangeType.WorkflowStepCompleted => "bi-check-square",
        FormRequestChangeType.WorkflowStepApproved => "bi-check-circle-fill",
        FormRequestChangeType.WorkflowStepRejected => "bi-x-circle-fill",
        FormRequestChangeType.WorkflowCompleted => "bi-flag-fill",
        _ => "bi-circle"
    };

    private string GetHistoryTitle(FormRequestChangeType changeType) => changeType switch
    {
        FormRequestChangeType.Created => "Request Created",
        FormRequestChangeType.Updated => "Request Updated",
        FormRequestChangeType.StatusChanged => "Status Changed",
        FormRequestChangeType.Approved => "Request Approved",
        FormRequestChangeType.Rejected => "Request Rejected",
        FormRequestChangeType.Applied => "Changes Applied",
        FormRequestChangeType.Failed => "Application Failed",
        FormRequestChangeType.WorkflowStarted => "Workflow Started",
        FormRequestChangeType.WorkflowStepCompleted => "Workflow Step Completed",
        FormRequestChangeType.WorkflowStepApproved => "Workflow Step Approved",
        FormRequestChangeType.WorkflowStepRejected => "Workflow Step Rejected",
        FormRequestChangeType.WorkflowCompleted => "Workflow Completed",
        _ => changeType.ToString()
    };

    private string GetFieldDisplayName(string fieldName)
    {
        if (fieldName.StartsWith("Original_"))
        {
            var actualFieldName = fieldName.Substring(9);
            var field = _formDefinition?.Fields?.FirstOrDefault(f => f.Name == actualFieldName);
            return field?.DisplayName ?? actualFieldName;
        }

        var formField = _formDefinition?.Fields?.FirstOrDefault(f => f.Name == fieldName);
        return formField?.DisplayName ?? fieldName;
    }

    private bool IsWorkflowHistoryType(FormRequestChangeType changeType) => changeType switch
    {
        FormRequestChangeType.WorkflowStarted => true,
        FormRequestChangeType.WorkflowStepCompleted => true,
        FormRequestChangeType.WorkflowStepApproved => true,
        FormRequestChangeType.WorkflowStepRejected => true,
        FormRequestChangeType.WorkflowCompleted => true,
        _ => false
    };

    private string GetActionBadgeClass(string? action) => action switch
    {
        "Approved" => "bg-success",
        "Rejected" => "bg-danger",
        "Completed" => "bg-primary",
        _ => "bg-secondary"
    };
}
