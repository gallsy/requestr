@page "/forms/{FormId:int}/bulk-upload"
@using Requestr.Core.Models
@using Requestr.Core.Models.DTOs
@using Requestr.Core.Interfaces
@using Dapper
@inject IFormDefinitionService FormDefinitionService
@inject IBulkFormRequestService BulkFormRequestService
@inject IDataService DataService
@inject IConfiguration _configuration
@inject IToastNotificationService ToastService
@inject ILogger<BulkUpload> Logger
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<PageTitle>Bulk Upload - @_formDefinition?.Name</PageTitle>

@if (_isLoading)
{
    <LoadingSpinner Message="Loading form..." />
}
else if (_formDefinition == null)
{
    <EmptyState Title="Form Not Found" 
                Description="The requested form could not be found or you don't have permission to access it.">
        <Action>
            <button class="btn btn-primary" @onclick="@(() => Navigation.NavigateTo("/"))">
                Go Home
            </button>
        </Action>
    </EmptyState>
}
else
{
    <PageHeader Title="Bulk Upload" Description="@($"Upload Excel data for {_formDefinition.Name}")">
        <Actions>
            <a href="/forms/@FormId" class="btn btn-outline-secondary me-2">
                <i class="bi bi-arrow-left me-2"></i>
                Back to Form
            </a>
            <button class="btn btn-outline-info" @onclick="DownloadTemplate">
                <i class="bi bi-download me-2"></i>
                Download Template
            </button>
        </Actions>
    </PageHeader>

    <div class="container">

                <!-- Step 1: Upload & Request Type Selection -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-1-circle me-2"></i>
                            Upload Excel File & Select Request Type
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Select Request Type</label>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="requestType" id="insert" value="@RequestType.Insert" @onchange="OnRequestTypeChanged" checked="@(_selectedRequestType == RequestType.Insert)">
                                        <label class="form-check-label" for="insert">
                                            <span class="badge bg-primary me-2">Insert</span>
                                            Add new records
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="requestType" id="update" value="@RequestType.Update" @onchange="OnRequestTypeChanged" checked="@(_selectedRequestType == RequestType.Update)">
                                        <label class="form-check-label" for="update">
                                            <span class="badge bg-info me-2">Update</span>
                                            Modify existing records
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="requestType" id="delete" value="@RequestType.Delete" @onchange="OnRequestTypeChanged" checked="@(_selectedRequestType == RequestType.Delete)">
                                        <label class="form-check-label" for="delete">
                                            <span class="badge bg-danger me-2">Delete</span>
                                            Remove existing records
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Upload Excel File</label>
                                <div class="mb-3">
                                    <InputFile OnChange="OnFileSelected" class="form-control" accept=".xlsx" />
                                    <div class="form-text">
                                        Upload an Excel file (.xlsx) with column headers matching the form fields. Download the template for the correct format. Maximum file size: 10MB.
                                    </div>
                                </div>
                            </div>
                        </div>

                        @if (_isProcessing)
                        {
                            <LoadingSpinner Message="Processing Excel file..." />
                        }
                    </div>
                </div>

                <!-- Step 2: Validation Results -->
                @if (_uploadResult != null)
                {
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-2-circle me-2"></i>
                                Validation Results
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h4 text-primary">@_uploadResult.TotalRows</div>
                                        <div class="text-muted">Total Rows</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h4 text-success">@_uploadResult.ValidRows</div>
                                        <div class="text-muted">Valid Rows</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h4 text-danger">@_uploadResult.InvalidRows</div>
                                        <div class="text-muted">Invalid Rows</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h4 text-info">@_selectedRowCount</div>
                                        <div class="text-muted">Selected</div>
                                    </div>
                                </div>
                            </div>

                            @if (_uploadResult.Errors.Any())
                            {
                                <div class="alert alert-danger mt-3">
                                    <h6>File Processing Errors:</h6>
                                    <ul class="mb-0">
                                        @foreach (var error in _uploadResult.Errors)
                                        {
                                            <li>@error</li>
                                        }
                                    </ul>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Step 3: Data Preview -->
                    @if (_uploadResult.IsValid || _uploadResult.ValidationResults.Any())
                    {
                        <div class="card mb-4">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="bi bi-3-circle me-2"></i>
                                        Data Preview & Selection
                                    </h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary me-2" @onclick="SelectAll">
                                            Select All Valid
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" @onclick="SelectNone">
                                            Select None
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th width="50">
                                                    <input type="checkbox" @onchange="OnSelectAllChanged" checked="@_allSelected" />
                                                </th>
                                                <th width="80">Row</th>
                                                <th width="80">Status</th>
                                                @foreach (var field in _formDefinition.Fields.Where(f => f.IsVisible).OrderBy(f => f.DisplayOrder))
                                                {
                                                    <th>@field.DisplayName</th>
                                                }
                                                <th width="150">Errors</th>
                                                <th width="150">Warnings</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @for (int i = 0; i < _uploadResult.ValidationResults.Count; i++)
                                            {
                                                var result = _uploadResult.ValidationResults[i];
                                                var rowKey = result.RowNumber; // keep selection keyed by spreadsheet row number to avoid index drift
                                                var isSelected = _selectedRows.Contains(rowKey);
                                                <tr class="@(result.IsValid ? (result.Warnings.Any() ? "table-warning" : "") : "table-danger")">
                                                    <td>
                                                        @if (result.IsValid)
                                                        {
                                                            <input type="checkbox" @onchange="@(e => OnRowSelectionChanged(rowKey, e))" checked="@isSelected" />
                                                        }
                                                    </td>
                                                    <td>@result.RowNumber</td>
                                                    <td>
                                                        @if (result.IsValid)
                                                        {
                                                            <span class="badge bg-success">Valid</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-danger">Invalid</span>
                                                        }
                                                    </td>
                                                    @foreach (var field in _formDefinition.Fields.Where(f => f.IsVisible).OrderBy(f => f.DisplayOrder))
                                                    {
                                                        <td>
                                                            @if (result.ParsedData.TryGetValue(field.Name, out var value))
                                                            {
                                                                @(value?.ToString() ?? "")
                                                            }
                                                        </td>
                                                    }
                                                    <td>
                                                        @if (result.Errors.Any())
                                                        {
                                                            <small class="text-danger">
                                                                @string.Join("; ", result.Errors)
                                                            </small>
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (result.Warnings.Any())
                                                        {
                                                            <small class="text-warning">
                                                                @string.Join("; ", result.Warnings)
                                                            </small>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Step 4: Submit -->
                    @if (_uploadResult.IsValid && _selectedRows.Any())
                    {
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-4-circle me-2"></i>
                                    Submit Request
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Comments (Optional)</label>
                                        <textarea class="form-control" rows="3" @bind="_comments" placeholder="Add any additional comments for the reviewers..."></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex flex-column h-100">
                                            <div class="mb-3">
                                                <strong>Request Summary:</strong>
                                                <ul class="list-unstyled mt-2">
                                                    <li><strong>Type:</strong> @_selectedRequestType</li>
                                                    <li><strong>Form:</strong> @_formDefinition.Name</li>
                                                    <li><strong>Selected Rows:</strong> @_selectedRows.Count</li>
                                                    <li><strong>File:</strong> @_selectedFileName</li>
                                                </ul>
                                            </div>
                                            <div class="mt-auto">
                                                <button class="btn btn-primary btn-lg" @onclick="SubmitBulkRequest" disabled="@_isSubmitting">
                                                    @if (_isSubmitting)
                                                    {
                                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                                        <text>Submitting...</text>
                                                    }
                                                    else
                                                    {
                                                        <i class="bi bi-check-lg me-2"></i>
                                                        <text>Submit Bulk Request</text>
                                                    }
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
</div>
}

@code {
    [Parameter] public int FormId { get; set; }

    private FormDefinition? _formDefinition;
    private bool _isLoading = true;
    private bool _isProcessing = false;
    private bool _isSubmitting = false;
    private RequestType _selectedRequestType = RequestType.Insert;
    private string _selectedFileName = "";
    private string _comments = "";
    private SpreadsheetUploadResult? _uploadResult;
    private HashSet<int> _selectedRows = new();
    private bool _allSelected = false;
    private int _selectedRowCount = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _formDefinition = await FormDefinitionService.GetFormDefinitionAsync(FormId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading form definition for FormId {FormId}", FormId);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        _selectedFileName = file.Name;
        _isProcessing = true;
        _uploadResult = null;
        _selectedRows.Clear();
        _selectedRowCount = 0;

        try
        {
            if (file.Size > 10 * 1024 * 1024) // 10MB limit
            {
                _uploadResult = new SpreadsheetUploadResult
                {
                    IsValid = false,
                    Errors = new List<string> { "File size exceeds 10MB limit" }
                };
                return;
            }

            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            _uploadResult = await BulkFormRequestService.ProcessSpreadsheetUploadAsync(FormId, stream, file.Name);

            // Check for duplicate primary key values within the file (for INSERT operations)
            if (_uploadResult != null && _uploadResult.ValidationResults.Any(v => v.IsValid))
            {
                await CheckForDuplicatePrimaryKeysInFile();
            }
        }
        catch (Exception ex)
        {
            _uploadResult = new SpreadsheetUploadResult
            {
                IsValid = false,
                Errors = new List<string> { $"Error processing file: {ex.Message}" }
            };
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private void OnRequestTypeChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<RequestType>(e.Value?.ToString(), out var requestType))
        {
            _selectedRequestType = requestType;
        }
    }

    private void OnRowSelectionChanged(int rowNumber, ChangeEventArgs e)
    {
        var isChecked = e.Value is bool b ? b : bool.TryParse(e.Value?.ToString(), out var parsed) && parsed;
        if (isChecked)
        {
            _selectedRows.Add(rowNumber);
        }
        else
        {
            _selectedRows.Remove(rowNumber);
        }
        
        _selectedRowCount = _selectedRows.Count;
        _allSelected = _selectedRows.Count == _uploadResult?.ValidRows;
    }

    private void OnSelectAllChanged(ChangeEventArgs e)
    {
        var isChecked = (bool)(e.Value ?? false);
        if (isChecked)
        {
            SelectAll();
        }
        else
        {
            SelectNone();
        }
    }

    private void SelectAll()
    {
        _selectedRows.Clear();
        if (_uploadResult?.ValidationResults != null)
        {
            for (int i = 0; i < _uploadResult.ValidationResults.Count; i++)
            {
                var validationResult = _uploadResult.ValidationResults[i];
                if (validationResult.IsValid)
                {
                    _selectedRows.Add(validationResult.RowNumber);
                }
            }
        }
        _selectedRowCount = _selectedRows.Count;
        _allSelected = true;
    }

    private void SelectNone()
    {
        _selectedRows.Clear();
        _selectedRowCount = 0;
        _allSelected = false;
    }

    private async Task SubmitBulkRequest()
    {
        if (_uploadResult == null || _formDefinition == null) return;

        _isSubmitting = true;
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst("sub")?.Value ?? 
                        authState.User.FindFirst("oid")?.Value ?? 
                        authState.User.Identity?.Name ?? "";
            var userName = authState.User.Identity?.Name ?? "";

            // For Update/Delete operations, we need to get primary key columns to lookup original values
            List<string> primaryKeyColumns = new();
            if (_selectedRequestType == RequestType.Update || _selectedRequestType == RequestType.Delete)
            {
                try
                {
                    primaryKeyColumns = await DataService.GetPrimaryKeyColumnsAsync(
                        _formDefinition.DatabaseConnectionName,
                        _formDefinition.TableName,
                        _formDefinition.Schema);
                        
                    if (!primaryKeyColumns.Any())
                    {
                        ToastService.ShowError($"Cannot perform {_selectedRequestType} operations: Table '{_formDefinition.TableName}' has no primary key defined.");
                        return;
                    }
                }
                catch (Exception ex)
                {
                    ToastService.ShowError($"Error checking primary keys: {ex.Message}");
                    return;
                }
            }

            var formRequestDtos = new List<CreateFormRequestDto>();

            foreach (var rowNumber in _selectedRows)
            {
                // Safety guard: ensure the selected row number exists in validation results
                var validationResult = _uploadResult.ValidationResults
                    .FirstOrDefault(v => v.RowNumber == rowNumber);
                if (validationResult == null)
                {
                    ToastService.ShowError($"Selected row {rowNumber} could not be matched. Please re-upload the file and try again.");
                    Logger.LogWarning("BulkUpload: Selected row number {RowNumber} not found. ValidationResultsCount={Count}", rowNumber, _uploadResult.ValidationResults.Count);
                    return;
                }

                var parsedData = validationResult.ParsedData;
                var originalValues = new Dictionary<string, object?>();

                // For Update/Delete operations, lookup the original values from the database
                if (_selectedRequestType == RequestType.Update || _selectedRequestType == RequestType.Delete)
                {
                    try
                    {
                        // Build WHERE conditions using primary key columns from the spreadsheet data
                        var whereConditions = new Dictionary<string, object?>();
                        foreach (var pkColumn in primaryKeyColumns)
                        {
                            if (parsedData.ContainsKey(pkColumn))
                            {
                                whereConditions[pkColumn] = parsedData[pkColumn];
                            }
                            else
                            {
                                throw new InvalidOperationException($"Primary key column '{pkColumn}' not found in spreadsheet data. Required for {_selectedRequestType} operations.");
                            }
                        }

                        // Query the database to get the current record
                        var existingRecords = await DataService.QueryDataAsync(
                            _formDefinition.DatabaseConnectionName,
                            _formDefinition.TableName,
                            _formDefinition.Schema,
                            whereConditions);

                        if (existingRecords.Count == 0)
                        {
                            throw new InvalidOperationException($"No record found with primary key values: {string.Join(", ", whereConditions.Select(kvp => $"{kvp.Key}={kvp.Value}"))}");
                        }
                        else if (existingRecords.Count > 1)
                        {
                            throw new InvalidOperationException($"Multiple records found with primary key values: {string.Join(", ", whereConditions.Select(kvp => $"{kvp.Key}={kvp.Value}"))}");
                        }

                        // Use the existing record values as original values
                        originalValues = existingRecords.First();
                    }
                    catch (Exception ex)
                    {
                        ToastService.ShowError($"Error looking up original values for row {rowNumber}: {ex.Message}");
                        return;
                    }
                }

                formRequestDtos.Add(new CreateFormRequestDto
                {
                    FormDefinitionId = FormId,
                    RequestType = _selectedRequestType,
                    FieldValues = parsedData,
                    OriginalValues = originalValues
                });
            }

            var createDto = new CreateBulkFormRequestDto
            {
                FormDefinitionId = FormId,
                RequestType = _selectedRequestType,
                FileName = _selectedFileName,
                Comments = _comments,
                FormRequests = formRequestDtos
            };

            var bulkRequest = await BulkFormRequestService.CreateBulkFormRequestAsync(createDto, userId, userName);
            
            // Navigate to the request details page
            Navigation.NavigateTo($"/bulk-requests/{bulkRequest.Id}");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error submitting request: {ex.Message}");
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private async Task DownloadTemplate()
    {
        if (_formDefinition == null) return;

        var fields = _formDefinition.Fields
            .Where(f => f.IsVisible)
            .OrderBy(f => f.DisplayOrder)
            .ToList();

        using var memoryStream = new MemoryStream();
        using (var spreadsheet = DocumentFormat.OpenXml.Packaging.SpreadsheetDocument.Create(memoryStream, DocumentFormat.OpenXml.SpreadsheetDocumentType.Workbook))
        {
            var workbookPart = spreadsheet.AddWorkbookPart();
            workbookPart.Workbook = new DocumentFormat.OpenXml.Spreadsheet.Workbook();

            var worksheetPart = workbookPart.AddNewPart<DocumentFormat.OpenXml.Packaging.WorksheetPart>();
            var sheetData = new DocumentFormat.OpenXml.Spreadsheet.SheetData();
            worksheetPart.Worksheet = new DocumentFormat.OpenXml.Spreadsheet.Worksheet();
            worksheetPart.Worksheet.Append(sheetData);

            var sheets = workbookPart.Workbook.AppendChild(new DocumentFormat.OpenXml.Spreadsheet.Sheets());
            var sheet = new DocumentFormat.OpenXml.Spreadsheet.Sheet
            {
                Id = workbookPart.GetIdOfPart(worksheetPart),
                SheetId = 1,
                Name = "Data"
            };
            sheets.Append(sheet);

            // Create header row
            var headerRow = new DocumentFormat.OpenXml.Spreadsheet.Row { RowIndex = 1 };
            for (int i = 0; i < fields.Count; i++)
            {
                var cell = new DocumentFormat.OpenXml.Spreadsheet.Cell
                {
                    CellReference = GetColumnLetter(i) + "1",
                    DataType = DocumentFormat.OpenXml.Spreadsheet.CellValues.String,
                    CellValue = new DocumentFormat.OpenXml.Spreadsheet.CellValue(fields[i].Name)
                };
                headerRow.Append(cell);
            }
            sheetData.Append(headerRow);

            // Build data validations for row 2 onwards
            var dataValidations = new DocumentFormat.OpenXml.Spreadsheet.DataValidations();
            uint validationCount = 0;

            for (int i = 0; i < fields.Count; i++)
            {
                var field = fields[i];
                var colLetter = GetColumnLetter(i);
                var sqref = $"{colLetter}2:{colLetter}1000";
                var dataType = field.DataType?.ToLower() ?? "string";
                var controlType = field.ControlType?.ToLower() ?? "";

                DocumentFormat.OpenXml.Spreadsheet.DataValidation? dv = null;

                if (dataType == "checkbox" || controlType == "checkbox" || dataType == "bool" || dataType == "boolean" || dataType == "bit")
                {
                    dv = new DocumentFormat.OpenXml.Spreadsheet.DataValidation
                    {
                        Type = DocumentFormat.OpenXml.Spreadsheet.DataValidationValues.List,
                        AllowBlank = !field.IsRequired,
                        ShowInputMessage = true,
                        ShowErrorMessage = true,
                        ShowDropDown = false,
                        PromptTitle = new DocumentFormat.OpenXml.StringValue(TruncateString(field.DisplayName, 32)),
                        Prompt = new DocumentFormat.OpenXml.StringValue("Select TRUE or FALSE"),
                        ErrorTitle = new DocumentFormat.OpenXml.StringValue("Invalid value"),
                        Error = new DocumentFormat.OpenXml.StringValue("Please select TRUE or FALSE")
                    };
                    dv.SequenceOfReferences = new DocumentFormat.OpenXml.ListValue<DocumentFormat.OpenXml.StringValue>(
                        new[] { new DocumentFormat.OpenXml.StringValue(sqref) });
                    dv.Formula1 = new DocumentFormat.OpenXml.Spreadsheet.Formula1("\"TRUE,FALSE\"");
                }
                else if (dataType == "datetime-local" || controlType == "datetime-local" || dataType == "datetime" || dataType == "datetime2" || dataType == "smalldatetime")
                {
                    // DateTime with time component
                    dv = new DocumentFormat.OpenXml.Spreadsheet.DataValidation
                    {
                        Type = DocumentFormat.OpenXml.Spreadsheet.DataValidationValues.Date,
                        Operator = DocumentFormat.OpenXml.Spreadsheet.DataValidationOperatorValues.GreaterThan,
                        AllowBlank = !field.IsRequired,
                        ShowInputMessage = true,
                        ShowErrorMessage = true,
                        PromptTitle = new DocumentFormat.OpenXml.StringValue(TruncateString(field.DisplayName, 32)),
                        Prompt = new DocumentFormat.OpenXml.StringValue("Enter date and time (YYYY-MM-DD HH:MM:SS)"),
                        ErrorTitle = new DocumentFormat.OpenXml.StringValue("Invalid date/time"),
                        Error = new DocumentFormat.OpenXml.StringValue("Please enter a valid date and time")
                    };
                    dv.SequenceOfReferences = new DocumentFormat.OpenXml.ListValue<DocumentFormat.OpenXml.StringValue>(
                        new[] { new DocumentFormat.OpenXml.StringValue(sqref) });
                    dv.Formula1 = new DocumentFormat.OpenXml.Spreadsheet.Formula1("0");
                }
                else if (dataType == "date" || controlType == "date")
                {
                    // Date only (no time component)
                    dv = new DocumentFormat.OpenXml.Spreadsheet.DataValidation
                    {
                        Type = DocumentFormat.OpenXml.Spreadsheet.DataValidationValues.Date,
                        Operator = DocumentFormat.OpenXml.Spreadsheet.DataValidationOperatorValues.GreaterThan,
                        AllowBlank = !field.IsRequired,
                        ShowInputMessage = true,
                        ShowErrorMessage = true,
                        PromptTitle = new DocumentFormat.OpenXml.StringValue(TruncateString(field.DisplayName, 32)),
                        Prompt = new DocumentFormat.OpenXml.StringValue("Enter a date (YYYY-MM-DD)"),
                        ErrorTitle = new DocumentFormat.OpenXml.StringValue("Invalid date"),
                        Error = new DocumentFormat.OpenXml.StringValue("Please enter a valid date")
                    };
                    dv.SequenceOfReferences = new DocumentFormat.OpenXml.ListValue<DocumentFormat.OpenXml.StringValue>(
                        new[] { new DocumentFormat.OpenXml.StringValue(sqref) });
                    dv.Formula1 = new DocumentFormat.OpenXml.Spreadsheet.Formula1("0");
                }
                else if (dataType == "number" || controlType == "number" || dataType == "int" || dataType == "integer" || dataType == "bigint" || dataType == "smallint" || dataType == "tinyint")
                {
                    dv = new DocumentFormat.OpenXml.Spreadsheet.DataValidation
                    {
                        Type = DocumentFormat.OpenXml.Spreadsheet.DataValidationValues.Whole,
                        Operator = DocumentFormat.OpenXml.Spreadsheet.DataValidationOperatorValues.Between,
                        AllowBlank = !field.IsRequired,
                        ShowInputMessage = true,
                        ShowErrorMessage = true,
                        PromptTitle = new DocumentFormat.OpenXml.StringValue(TruncateString(field.DisplayName, 32)),
                        Prompt = new DocumentFormat.OpenXml.StringValue("Enter a whole number"),
                        ErrorTitle = new DocumentFormat.OpenXml.StringValue("Invalid number"),
                        Error = new DocumentFormat.OpenXml.StringValue("Please enter a valid whole number")
                    };
                    dv.SequenceOfReferences = new DocumentFormat.OpenXml.ListValue<DocumentFormat.OpenXml.StringValue>(
                        new[] { new DocumentFormat.OpenXml.StringValue(sqref) });
                    dv.Formula1 = new DocumentFormat.OpenXml.Spreadsheet.Formula1("-2147483648");
                    dv.Formula2 = new DocumentFormat.OpenXml.Spreadsheet.Formula2("2147483647");
                }
                else if (dataType == "decimal" || dataType == "float" || dataType == "double" || dataType == "money" || dataType == "numeric")
                {
                    dv = new DocumentFormat.OpenXml.Spreadsheet.DataValidation
                    {
                        Type = DocumentFormat.OpenXml.Spreadsheet.DataValidationValues.Decimal,
                        Operator = DocumentFormat.OpenXml.Spreadsheet.DataValidationOperatorValues.Between,
                        AllowBlank = !field.IsRequired,
                        ShowInputMessage = true,
                        ShowErrorMessage = true,
                        PromptTitle = new DocumentFormat.OpenXml.StringValue(TruncateString(field.DisplayName, 32)),
                        Prompt = new DocumentFormat.OpenXml.StringValue("Enter a decimal number"),
                        ErrorTitle = new DocumentFormat.OpenXml.StringValue("Invalid number"),
                        Error = new DocumentFormat.OpenXml.StringValue("Please enter a valid number")
                    };
                    dv.SequenceOfReferences = new DocumentFormat.OpenXml.ListValue<DocumentFormat.OpenXml.StringValue>(
                        new[] { new DocumentFormat.OpenXml.StringValue(sqref) });
                    dv.Formula1 = new DocumentFormat.OpenXml.Spreadsheet.Formula1("-999999999999");
                    dv.Formula2 = new DocumentFormat.OpenXml.Spreadsheet.Formula2("999999999999");
                }
                else if ((dataType == "text" || controlType == "text" || controlType == "input" || controlType == "textarea" || dataType == "string" || dataType == "nvarchar" || dataType == "varchar" || dataType == "nchar" || dataType == "char") && field.MaxLength > 0)
                {
                    dv = new DocumentFormat.OpenXml.Spreadsheet.DataValidation
                    {
                        Type = DocumentFormat.OpenXml.Spreadsheet.DataValidationValues.TextLength,
                        Operator = DocumentFormat.OpenXml.Spreadsheet.DataValidationOperatorValues.LessThanOrEqual,
                        AllowBlank = !field.IsRequired,
                        ShowInputMessage = true,
                        ShowErrorMessage = true,
                        PromptTitle = new DocumentFormat.OpenXml.StringValue(TruncateString(field.DisplayName, 32)),
                        Prompt = new DocumentFormat.OpenXml.StringValue($"Max {field.MaxLength} characters"),
                        ErrorTitle = new DocumentFormat.OpenXml.StringValue("Text too long"),
                        Error = new DocumentFormat.OpenXml.StringValue($"Maximum {field.MaxLength} characters")
                    };
                    dv.SequenceOfReferences = new DocumentFormat.OpenXml.ListValue<DocumentFormat.OpenXml.StringValue>(
                        new[] { new DocumentFormat.OpenXml.StringValue(sqref) });
                    dv.Formula1 = new DocumentFormat.OpenXml.Spreadsheet.Formula1(field.MaxLength.ToString());
                }

                if (dv != null)
                {
                    dataValidations.Append(dv);
                    validationCount++;
                }
            }

            if (validationCount > 0)
            {
                dataValidations.Count = validationCount;
                worksheetPart.Worksheet.InsertAfter(dataValidations, sheetData);
            }

            worksheetPart.Worksheet.Save();
            workbookPart.Workbook.Save();
        }

        var bytes = memoryStream.ToArray();
        var fileName = $"{_formDefinition.Name}_template.xlsx";

        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", bytes);
    }

    private static string GetColumnLetter(int columnIndex)
    {
        var result = string.Empty;
        var temp = columnIndex;
        while (temp >= 0)
        {
            result = (char)('A' + (temp % 26)) + result;
            temp = temp / 26 - 1;
        }
        return result;
    }

    private static string TruncateString(string value, int maxLength)
    {
        if (string.IsNullOrEmpty(value)) return value;
        return value.Length <= maxLength ? value : value[..maxLength];
    }

    /// <summary>
    /// Validates primary keys based on the request type:
    /// - INSERT with identity PK: Warn if user supplied values (they'll be ignored)
    /// - INSERT with manual PK: Check for duplicates in file AND existing records in database
    /// - UPDATE: Check that records exist in database
    /// </summary>
    private async Task CheckForDuplicatePrimaryKeysInFile()
    {
        if (_formDefinition == null || _uploadResult == null) return;

        try
        {
            // Get primary key columns for the table
            var primaryKeyColumns = await DataService.GetPrimaryKeyColumnsAsync(
                _formDefinition.DatabaseConnectionName,
                _formDefinition.TableName,
                _formDefinition.Schema);

            if (!primaryKeyColumns.Any()) return;

            var identityColumns = await GetIdentityColumnsAsync();
            var nonIdentityPkColumns = primaryKeyColumns
                .Where(pk => !identityColumns.Contains(pk, StringComparer.OrdinalIgnoreCase))
                .ToList();

            // Get valid rows for processing
            var validRows = _uploadResult.ValidationResults
                .Where(v => v.IsValid)
                .ToList();

            if (!validRows.Any()) return;

            if (_selectedRequestType == RequestType.Insert)
            {
                await ValidateInsertPrimaryKeys(primaryKeyColumns, identityColumns, nonIdentityPkColumns, validRows);
            }
            else if (_selectedRequestType == RequestType.Update || _selectedRequestType == RequestType.Delete)
            {
                await ValidateUpdateDeletePrimaryKeys(primaryKeyColumns, validRows);
            }

            // Update overall validity
            _uploadResult.IsValid = _uploadResult.InvalidRows == 0 && _uploadResult.ValidRows > 0;
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Error validating primary keys in bulk upload");
        }
    }

    /// <summary>
    /// Validates INSERT operations:
    /// - Warns if identity column values are supplied (they'll be ignored)
    /// - Checks for duplicate PKs within the file
    /// - Checks for existing PKs in the database
    /// </summary>
    private async Task ValidateInsertPrimaryKeys(
        List<string> primaryKeyColumns,
        HashSet<string> identityColumns,
        List<string> nonIdentityPkColumns,
        List<SpreadsheetRowValidationResult> validRows)
    {
        // Check if user supplied values for identity columns (warn - they'll be ignored)
        var identityPkColumns = primaryKeyColumns
            .Where(pk => identityColumns.Contains(pk, StringComparer.OrdinalIgnoreCase))
            .ToList();

        if (identityPkColumns.Any())
        {
            foreach (var row in validRows)
            {
                var parsedDataCi = new Dictionary<string, object?>(row.ParsedData, StringComparer.OrdinalIgnoreCase);
                foreach (var identityCol in identityPkColumns)
                {
                    if (parsedDataCi.TryGetValue(identityCol, out var value) && value != null && !string.IsNullOrWhiteSpace(value.ToString()))
                    {
                        row.Warnings.Add($"Column '{identityCol}' is auto-generated; supplied value '{value}' will be ignored");
                    }
                }
            }
        }

        // If all PK columns are identity, no further validation needed
        if (!nonIdentityPkColumns.Any()) return;

        // Build map of composite PK values to row numbers for duplicate detection
        var pkValueToRows = new Dictionary<string, List<int>>(StringComparer.OrdinalIgnoreCase);
        var rowPkValues = new Dictionary<int, (string CompositeKey, Dictionary<string, object?> PkValues)>();

        foreach (var row in validRows)
        {
            var pkValues = new Dictionary<string, object?>(StringComparer.OrdinalIgnoreCase);
            var allPkColumnsPresent = true;
            var parsedDataCi = new Dictionary<string, object?>(row.ParsedData, StringComparer.OrdinalIgnoreCase);

            foreach (var pkColumn in nonIdentityPkColumns)
            {
                if (parsedDataCi.TryGetValue(pkColumn, out var value) && value != null && !string.IsNullOrWhiteSpace(value.ToString()))
                {
                    pkValues[pkColumn] = value;
                }
                else
                {
                    allPkColumnsPresent = false;
                    break;
                }
            }

            if (!allPkColumnsPresent) continue;

            // Trim values for consistent comparison with database results (handles char column padding)
            var compositeKey = string.Join("||", nonIdentityPkColumns.Select(col => pkValues[col]?.ToString()?.Trim() ?? ""));
            rowPkValues[row.RowNumber] = (compositeKey, pkValues);

            if (!pkValueToRows.ContainsKey(compositeKey))
            {
                pkValueToRows[compositeKey] = new List<int>();
            }
            pkValueToRows[compositeKey].Add(row.RowNumber);
        }

        // Check for duplicates within the file
        var duplicates = pkValueToRows.Where(kvp => kvp.Value.Count > 1).ToList();
        foreach (var duplicate in duplicates)
        {
            var rowNumbers = duplicate.Value;
            var pkDisplay = FormatPkDisplay(nonIdentityPkColumns, duplicate.Key);

            // Mark all but the first occurrence as duplicates
            foreach (var rowNumber in rowNumbers.Skip(1))
            {
                MarkRowInvalid(rowNumber, $"Duplicate primary key in file: {pkDisplay} (same as row {rowNumbers.First()})");
            }
        }

        // Check for existing records in database
        if (rowPkValues.Any())
        {
            var existingPks = await CheckExistingPrimaryKeysInDatabase(nonIdentityPkColumns, rowPkValues.Values.Select(v => v.PkValues).ToList());
            
            foreach (var rowEntry in rowPkValues)
            {
                var rowNumber = rowEntry.Key;
                var compositeKey = rowEntry.Value.CompositeKey;

                if (existingPks.Contains(compositeKey))
                {
                    var pkDisplay = FormatPkDisplay(nonIdentityPkColumns, compositeKey);
                    MarkRowInvalid(rowNumber, $"Primary key already exists in database: {pkDisplay}");
                }
            }
        }


    }

    /// <summary>
    /// Validates UPDATE/DELETE operations - checks that records exist in database
    /// </summary>
    private async Task ValidateUpdateDeletePrimaryKeys(List<string> primaryKeyColumns, List<SpreadsheetRowValidationResult> validRows)
    {
        var rowPkValues = new Dictionary<int, (string CompositeKey, Dictionary<string, object?> PkValues)>();

        foreach (var row in validRows)
        {
            var pkValues = new Dictionary<string, object?>(StringComparer.OrdinalIgnoreCase);
            var allPkColumnsPresent = true;

            // Use case-insensitive lookup in ParsedData
            var parsedDataCaseInsensitive = new Dictionary<string, object?>(row.ParsedData, StringComparer.OrdinalIgnoreCase);

            foreach (var pkColumn in primaryKeyColumns)
            {
                if (parsedDataCaseInsensitive.TryGetValue(pkColumn, out var value) && value != null && !string.IsNullOrWhiteSpace(value.ToString()))
                {
                    pkValues[pkColumn] = value;
                }
                else
                {
                    allPkColumnsPresent = false;
                    MarkRowInvalid(row.RowNumber, $"Missing required primary key column '{pkColumn}' for {_selectedRequestType} operation");
                    break;
                }
            }

            if (!allPkColumnsPresent) continue;

            // Trim values for consistent comparison with database results (handles char column padding)
            var compositeKey = string.Join("||", primaryKeyColumns.Select(col => pkValues[col]?.ToString()?.Trim() ?? ""));
            rowPkValues[row.RowNumber] = (compositeKey, pkValues);
        }

        if (!rowPkValues.Any()) return;

        // Check which records exist in database
        var existingPks = await CheckExistingPrimaryKeysInDatabase(primaryKeyColumns, rowPkValues.Values.Select(v => v.PkValues).ToList());

        foreach (var rowEntry in rowPkValues)
        {
            var rowNumber = rowEntry.Key;
            var compositeKey = rowEntry.Value.CompositeKey;

            if (!existingPks.Contains(compositeKey))
            {
                var pkDisplay = FormatPkDisplay(primaryKeyColumns, compositeKey);
                MarkRowInvalid(rowNumber, $"Record not found in database: {pkDisplay}");
            }
        }

    }

    /// <summary>
    /// Queries the database to find which of the provided PK values already exist
    /// Returns a set of composite key strings that exist in the database
    /// </summary>
    private async Task<HashSet<string>> CheckExistingPrimaryKeysInDatabase(
        List<string> pkColumns, 
        List<Dictionary<string, object?>> pkValuesList)
    {
        var existingKeys = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        if (!pkValuesList.Any() || _formDefinition == null) return existingKeys;

        try
        {
            var connectionString = GetConnectionString(_formDefinition.DatabaseConnectionName);
            if (string.IsNullOrEmpty(connectionString)) 
            {
                Logger.LogWarning("No connection string found for {DbName}", _formDefinition.DatabaseConnectionName);
                return existingKeys;
            }

            using var connection = new Microsoft.Data.SqlClient.SqlConnection(connectionString);
            await connection.OpenAsync();

            // For single-column PKs, use efficient IN clause
            if (pkColumns.Count == 1)
            {
                var pkColumn = pkColumns[0];
                
                // Use case-insensitive lookup for dictionary access
                var values = pkValuesList
                    .Select(pv => {
                        var ciDict = new Dictionary<string, object?>(pv, StringComparer.OrdinalIgnoreCase);
                        return ciDict.TryGetValue(pkColumn, out var v) ? v?.ToString() : null;
                    })
                    .Where(v => !string.IsNullOrEmpty(v))
                    .Distinct()
                    .ToList();

                if (!values.Any()) return existingKeys;

                // Use parameterized query with individual parameters for safety
                var parameters = new DynamicParameters();
                var paramNames = new List<string>();
                for (int i = 0; i < values.Count; i++)
                {
                    var paramName = $"@p{i}";
                    paramNames.Add(paramName);
                    parameters.Add(paramName, values[i]);
                }

                var sql = $"SELECT [{pkColumn}] FROM [{_formDefinition.Schema}].[{_formDefinition.TableName}] WHERE [{pkColumn}] IN ({string.Join(", ", paramNames)})";
                var existingValues = await connection.QueryAsync<dynamic>(sql, parameters);

                foreach (var val in existingValues)
                {
                    // Handle different data types and trim char columns that may have trailing spaces
                    string? stringVal = null;
                    if (val is IDictionary<string, object> dict)
                    {
                        stringVal = dict.Values.FirstOrDefault()?.ToString()?.Trim();
                    }
                    else
                    {
                        stringVal = ((object?)val)?.ToString()?.Trim();
                    }
                    
                    if (!string.IsNullOrEmpty(stringVal))
                    {
                        existingKeys.Add(stringVal);
                    }
                }
            }
            else
            {
                // For composite PKs, build individual OR conditions
                // Batch into groups to avoid query size limits
                const int batchSize = 100;
                
                for (int batch = 0; batch < pkValuesList.Count; batch += batchSize)
                {
                    var batchItems = pkValuesList.Skip(batch).Take(batchSize).ToList();
                    var parameters = new DynamicParameters();
                    var conditions = new List<string>();

                    for (int i = 0; i < batchItems.Count; i++)
                    {
                        var item = batchItems[i];
                        var conditionParts = new List<string>();
                        
                        foreach (var pkCol in pkColumns)
                        {
                            var paramName = $"@p{batch + i}_{pkCol.Replace(" ", "_")}";
                            parameters.Add(paramName, item[pkCol]?.ToString());
                            conditionParts.Add($"[{pkCol}] = {paramName}");
                        }
                        
                        conditions.Add($"({string.Join(" AND ", conditionParts)})");
                    }

                    var selectColumns = string.Join(", ", pkColumns.Select(c => $"[{c}]"));
                    var sql = $"SELECT {selectColumns} FROM [{_formDefinition.Schema}].[{_formDefinition.TableName}] WHERE {string.Join(" OR ", conditions)}";
                    
                    var results = await connection.QueryAsync(sql, parameters);
                    
                    foreach (var row in results)
                    {
                        var dict = (IDictionary<string, object>)row;
                        // Trim values to handle char column padding
                        var compositeKey = string.Join("||", pkColumns.Select(col => dict[col]?.ToString()?.Trim() ?? ""));
                        existingKeys.Add(compositeKey);
                    }
                }
            }


        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Error checking existing primary keys in database");
        }

        return existingKeys;
    }

    private void MarkRowInvalid(int rowNumber, string errorMessage)
    {
        var validationResult = _uploadResult?.ValidationResults.FirstOrDefault(v => v.RowNumber == rowNumber);
        if (validationResult != null && validationResult.IsValid)
        {
            validationResult.IsValid = false;
            validationResult.Errors.Add(errorMessage);
            _uploadResult!.ValidRows--;
            _uploadResult.InvalidRows++;
        }
    }

    private static string FormatPkDisplay(List<string> pkColumns, string compositeKey)
    {
        var values = compositeKey.Split("||");
        return string.Join(", ", pkColumns.Zip(values, (col, val) => $"{col}={val}"));
    }

    private async Task<HashSet<string>> GetIdentityColumnsAsync()
    {
        if (_formDefinition == null) return new HashSet<string>();

        try
        {
            // Query to get identity columns for the table
            var connectionString = GetConnectionString(_formDefinition.DatabaseConnectionName);
            if (string.IsNullOrEmpty(connectionString)) return new HashSet<string>();

            using var connection = new Microsoft.Data.SqlClient.SqlConnection(connectionString);
            await connection.OpenAsync();

            const string sql = @"
                SELECT COLUMN_NAME 
                FROM INFORMATION_SCHEMA.COLUMNS 
                WHERE TABLE_NAME = @tableName 
                    AND TABLE_SCHEMA = @schema
                    AND COLUMNPROPERTY(OBJECT_ID(TABLE_SCHEMA + '.' + TABLE_NAME), COLUMN_NAME, 'IsIdentity') = 1";

            var identityColumns = await connection.QueryAsync<string>(sql, new 
            { 
                tableName = _formDefinition.TableName, 
                schema = _formDefinition.Schema 
            });

            return identityColumns.ToHashSet(StringComparer.OrdinalIgnoreCase);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Error getting identity columns for table {TableName}", _formDefinition.TableName);
            return new HashSet<string>();
        }
    }

    /// <summary>
    /// Gets a connection string by name, checking both ConnectionStrings and DatabaseConnections sections
    /// </summary>
    private string? GetConnectionString(string connectionStringName)
    {
        // Try to get from ConnectionStrings section first
        var connectionString = _configuration.GetConnectionString(connectionStringName);
        if (!string.IsNullOrEmpty(connectionString))
        {
            return connectionString;
        }
        
        // Try to get from DatabaseConnections section
        connectionString = _configuration.GetSection($"DatabaseConnections:{connectionStringName}").Value;
        return connectionString;
    }
}

<script>
    window.downloadFile = function (filename, contentType, content) {
        const blob = new Blob([content], { type: contentType });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        window.URL.revokeObjectURL(url);
    };
</script>
